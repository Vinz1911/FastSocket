# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

platform :ios do

  desc "build with Xcode tools"
  lane :build_xcode do
    UI.message("start building")
      xcodebuild(
        archive: nil,
        scheme: "FastSocket",
        destination: "generic/platform=iOS",
        sdk: "iphoneos"
      )
    UI.success("finished building")
  end

  desc "run unit tests"
  lane :test_xcode do
    UI.message("performing unit tests")
      scan
    UI.success("finished unit tests")
  end
  
  desc "create archive and .xcframework"
  lane :build_framework_xcode do
    # remove old build destination
    UI.message("remove old builds")
    sh("rm -rf framework")
    UI.message("successfully removed")
    # build and archive for generic ios platform
    UI.message("archive for generic ios platform")
    xcodebuild(
      archive: true,
      archive_path: "./fastlane/framework/FastSocket_iOS.xcarchive",
      scheme: "FastSocket",
      destination: "generic/platform=iOS",
      sdk: "iphoneos"
    )
    UI.message("successfully archived")
    # build and archive for ios simulator platform
    UI.message("archive for ios simulator")
    xcodebuild(
      archive: true,
      archive_path: "./fastlane/framework/FastSocket_Simulator.xcarchive",
      scheme: "FastSocket",
      destination: "platform=iOS Simulator,name=iPhone 11,OS=13.0",
      sdk: "iphonesimulator"
    )
    UI.message("successfully archived")
    # create .xcframework from the archives
    UI.message("create framework")
    sh("xcodebuild -create-xcframework -framework ./framework/FastSocket_iOS.xcarchive/Products/Library/Frameworks/FastSocket.framework -framework ./framework/FastSocket_Simulator.xcarchive/Products/Library/Frameworks/FastSocket.framework -output ./framework/FastSocket.xcframework")
    UI.message("successfully created")
  end
end
